# llvmtools: Stage1 LLVM  ( with clang,compiler-rt,libcxx,libcxxabi,libunwind,lld )
# Build as cmlfs
#
# NOTE: stage1 clang has broken C++ support.
#
# NOTE Reused unpacked LLVM source from building cgnutools

# Restore the default dynamic linker path to /lib.
# Binaries will be patched with patchelf
patch -Np1 -i ../patches/llvm1505-cmlfs/modify-test-dynamic-loader_back2default.patch
patch -Np1 -i ../patches/llvm1505-cmlfs/modify-toolchain-dynamic-loader_back2default.patch

# Set CC and CXX compiler with stage0 clang
export CXX=${TARGET_TUPLE}-clang++
export  CC=${TARGET_TUPLE}-clang

# Set flags to greatly reduce debugging symbols
CFLAGS=' -g -g1 -fPIC -Wl,-rpath,"\$$ORIGIN/../lib/x86_64-pc-linux-musl"'
CXXFLAGS=$CFLAGS
export CFLAGS CXXFLAGS

# Set the build options ..
export  CONFIG_OPTIONS="-DCMAKE_BUILD_TYPE=Release "
export CONFIG_OPTIONS+="-DBUILD_SHARED_LIBS=ON "
export CONFIG_OPTIONS+="-DLLVM_ENABLE_LIBCXX=ON "
export CONFIG_OPTIONS+="-DLLVM_TARGET_ARCH=X86 "
export CONFIG_OPTIONS+="-DLLVM_TARGETS_TO_BUILD=X86 "
export CONFIG_OPTIONS+="-DLIBCXX_HAS_MUSL_LIBC=ON "
export CONFIG_OPTIONS+="-DLLVM_ENABLE_EH=ON "
export CONFIG_OPTIONS+="-DLLVM_ENABLE_RTTI=ON "
export CONFIG_OPTIONS+="-DLLVM_BUILD_LLVM_DYLIB=ON "
export CONFIG_OPTIONS+="-DLLVM_ENABLE_TERMINFO=ON "

# Set the compiler and linker flags...
export LINKERFLAGS="-Wl,-dynamic-linker /llvmtools/lib/ld-musl-x86_64.so.1"
export  CONFIG_TOOLS="-DCMAKE_C_COMPILER=${CC} "
export CONFIG_TOOLS+="-DCMAKE_CXX_COMPILER=${CXX} "
export CONFIG_TOOLS+="-DCLANG_DEFAULT_LINKER=/llvmtools/bin/ld.lld "

# Set the tuples...
export  CONFIG_TUPLES="-DLLVM_DEFAULT_TARGET_TRIPLE=x86_64-pc-linux-musl "
export CONFIG_TUPLES+="-DLLVM_HOST_TRIPLE=x86_64-pc-linux-musl "
export CONFIG_TUPLES+="-DCOMPILER_RT_DEFAULT_TARGET_TRIPLE=x86_64-pc-linux-musl "

# Set the flags for Compiler-rt...
export  CONFIG_CRT="-DCOMPILER_RT_BUILD_SANITIZERS=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_BUILD_XRAY=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_BUILD_PROFILE=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_BUILD_LIBFUZZER=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_BUILD_ORC=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_CAN_EXECUTE_TESTS=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_HWASAN_WITH_INTERCEPTORS=OFF "
export CONFIG_CRT+="-DCOMPILER_RT_USE_BUILTINS_LIBRARY=ON "
export CONFIG_CRT+="-DCOMPILER_RT_USE_LLVM_UNWINDER=ON "
export CONFIG_CRT+="-DCOMPILER_RT_BUILD_STANDALONE_LIBATOMIC=ON "
export CONFIG_CRT+="-DCOMPILER_RT_EXCLUDE_ATOMIC_BUILTIN=OFF "

# Set the flags for clang:
export  CONFIG_CLANG="-DCLANG_DEFAULT_CXX_STDLIB=libc++ "
export CONFIG_CLANG+="-DCLANG_DEFAULT_UNWINDLIB=libunwind "
export CONFIG_CLANG+="-DCLANG_DEFAULT_RTLIB=compiler-rt "
export CONFIG_CLANG+="-DCLANG_ENABLE_STATIC_ANALYZER=OFF "
export CONFIG_CLANG+="-DCLANG_ENABLE_ARCMT=OFF "
export CONFIG_CLANG+="-DCLANG_TOOL_CLANG_IMPORT_TEST_BUILD=OFF "
export CONFIG_CLANG+="-DCLANG_TOOL_C_ARCMT_TEST_BUILD=OFF "
export CONFIG_CLANG+="-DCLANG_TOOL_C_INDEX_TEST_BUILD=OFF "
export CONFIG_CLANG+="-DCLANG_TOOL_AMDGPU_ARCH_BUILD=OFF "
export CONFIG_CLANG+="-DCLANG_TOOL_APINOTES_TEST_BUILD=OFF "
export CONFIG_CLANG+="-DCLANG_TOOL_ARCMT_TEST_BUILD=OFF "

# Set the flags to allow build static libraries for
# libunwind, libcxxabi, and libcxx:
export  CONFIG_LIBUNWIND="-DLIBUNWIND_ENABLE_STATIC=ON "
export  CONFIG_LIBCXXABI="-DLIBCXXABI_ENABLE_STATIC=ON "
export  CONFIG_LIBCXX="-DLIBCXX_ENABLE_STATIC=ON "

# Set the options for libc++
export CONFIG_LIBCXX+="-DLIBCXX_USE_COMPILER_RT=ON "
export CONFIG_LIBCXX+="-DLIBCXX_EXTRA_SITE_DEFINES=ON "
export CONFIG_LIBCXX+="-DLIBCXX_ENABLE_ASSERTIONS=ON "
export CONFIG_LIBCXX+="-DLIBCXX_ENABLE_LOCALIZATION=ON "
export CONFIG_LIBCXX+="-DLIBCXX_ENABLE_VENDOR_AVAILABILITY_ANNOTATIONS=OFF "
export CONFIG_LIBCXX+="-DLIBCXX_ENABLE_ABI_LINKER_SCRIPT=ON "
export CONFIG_LIBCXX+="-DLIBCXX_ENABLE_NEW_DELETE_DEFINITIONS=ON "

# Set the options for libc++abi
export CONFIG_LIBCXXABI+="-DLIBCXXABI_ENABLE_FORGIVING_DYNAMIC_CAST=ON "
export CONFIG_LIBCXXABI+="-DLIBCXXABI_USE_COMPILER_RT=ON "
export CONFIG_LIBCXXABI+="-DLIBCXXABI_USE_LLVM_UNWINDER=ON "

# Set the options for libunwind
export CONFIG_LIBUNWIND+="-DLIBUNWIND_ENABLE_CROSS_UNWINDING=ON "
export CONFIG+LIBUNWIND+="-DLIBUNWIND_INSTALL_HEADERS=ON "

# Set paths...
export  CONFIG_PATHS="-DCMAKE_INSTALL_PREFIX=/llvmtools "
export CONFIG_PATHS+="-DCMAKE_INSTALL_OLDINCLUDEDIR=/llvmtools/include "
export CONFIG_PATHS+="-DDEFAULT_SYSROOT=/llvmtools "
export CONFIG_PATHS+="-DBacktrace_LIBRARY=/llvmtools/lib/libexecinfo.so.1 "
export CONFIG_PATHS+="-DCOMPILER_RT_INSTALL_BINARY_DIR=/llvmtools/bin "
export CONFIG_PATHS+="-DCOMPILER_RT_INSTALL_DATA_DIR=/llvmtools/share "
#export CONFIG_PATHS+="-DCOMPILER_RT_INSTALL_INCLUDE_DIR=/llvmtools/include/clang/15.0.5 "   #default: lib/clang/15.0.5/include
#export CONFIG_PATHS+="-DCOMPILER_RT_INSTALL_LIBRARY_DIR=/llvmtools/lib/clang/15.0.5 "       #default: lib/clang/15.0.5/lib
#export CONFIG_PATHS+="-DLIBCXXABI_INSTALL_INCLUDE_DIR=/llvmtools/include/c++/v1 "           #default: include/c++/v1
#export CONFIG_PATHS+="-DLIBCXXABI_INSTALL_LIBRARY_DIR=/llvmtools/lib "                      #default: lib/x86_64-pc-linux-musl
#export CONFIG_PATHS+="-DLIBCXX_INSTALL_INCLUDE_DIR=/llvmtools/include/c++/v1 "              #default: include/c++/v1
#export CONFIG_PATHS+="-DLIBCXX_INSTALL_INCLUDE_TARGET_DIR=/llvmtools/include/c++/v1 "       #default: include/c++/v1
#export CONFIG_PATHS+="-DLIBCXX_INSTALL_LIBRARY_DIR=/llvmtools/lib "                         #default: lib/x86_64-pc-linux-musl
#export CONFIG_PATHS+="-DLIBCXX_INSTALL_RUNTIME_DIR=/llvmtools/bin "                         #default: bin
#export CONFIG_PATHS+="-DLIBUNWIND_INSTALL_LIBRARY_DIR=/llvmtools/lib "
#export CONFIG_PATHS+="-DLIBUNWIND_INSTALL_INCLUDE_DIR=/llvmtools/include "
#export CONFIG_PATHS+="-DLIBUNWIND_INSTALL_RUNTIME_DIR=/llvmtools/lib"

# Turn off unwanted features, docs and tests
export  BUILD_OFF="-DLLVM_BUILD_TESTS=OFF "
export BUILD_OFF+="-DLLVM_INCLUDE_GO_TESTS=OFF "
export BUILD_OFF+="-DLLVM_INCLUDE_TESTS=OFF "
export BUILD_OFF+="-DLLVM_INCLUDE_DOCS=OFF "
export BUILD_OFF+="-DLLVM_INCLUDE_EXAMPLES=OFF "
export BUILD_OFF+="-DLLVM_INCLUDE_BENCHMARKS=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_OCAMLDOC=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_BACKTRACES=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_LIBEDIT=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_LIBXML2=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_LIBPFM=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_ZLIB=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_Z3_SOLVER=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_CRASH_OVERRIDES=OFF "
export BUILD_OFF+="-DLLVM_ENABLE_ZSTD=OFF "
export BUILD_OFF+="-DLLVM_APPEND_VC_REV=OFF "
export BUILD_OFF+="-DLLVM_TOOL_XCODE_TOOLCHAIN_BUILD=OFF "
export BUILD_OFF+="-DLLVM_TOOL_LLVM_XRAY_BUILD=OFF "
export BUILD_OFF+="-DLLVM_TOOL_LLVM_MICROSOFT_DEMANGLE_FUZZER_BUILD=OFF "
export BUILD_OFF+="-DLLVM_TOOL_LLVM_ITANIUM_DEMANGLE_FUZZER_BUILD=OFF "
export BUILD_OFF+="-DLLVM_TOOL_LLVM_GO_BUILD=OFF "
export BUILD_OFF+="-DLLVM_TOOL_BUGPOINT_PASSES_BUILD=OFF "
export BUILD_OFF+="-DLLVM_TOOL_BUGPOINT_BUILD=OFF "
export BUILD_OFF+="-DLIBCXX_INCLUDE_BENCHMARKS=OFF "
export BUILD_OFF+="-DCOMPILER_RT_BUILD_GWP_ASAN=OFF -DCOMPILER_RT_BUILD_LIBFUZZER=OFF "

# Turn off more clang features not needed:
export  BOFF="-DCLANG_ENABLE_ARCMT=OFF      -DCLANG_ENABLE_STATIC_ANALYZER=OFF "
export BOFF+="-DCLANG_TOOL_APINOTES_TEST_BUILD=OFF -DCLANG_TOOL_ARCMT_TEST_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_CHECK_BUILD=OFF   -DCLANG_TOOL_CLANG_DIFF_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_EXTDEF_MAPPING_BUILD=OFF -DCLANG_TOOL_CLANG_FORMAT_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_FORMAT_VS_BUILD=OFF -DCLANG_TOOL_CLANG_FUZZER_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_IMPORT_TEST_BUILD=OFF -DCLANG_TOOL_CLANG_NVLINK_WRAPPER_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_OFFLOAD_BUNDLER_BUILD=OFF -DCLANG_TOOL_CLANG_OFFLOAD_PACKAGER_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_OFFLOAD_WRAPPER_BUILD=OFF -DCLANG_TOOL_CLANG_REFACTOR_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_RENAME_BUILD=OFF -DCLANG_TOOL_CLANG_REPL_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_CLANG_SCAN_DEPS_BUILD=OFF -DCLANG_TOOL_CLANG_SHLIB_BUILD=OFF"
export BOFF+="-DCLANG_TOOL_C_ARCMT_TEST_BUILD=OFF -DCLANG_TOOL_C_INDEX_TEST_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_DIAGTOOL_BUILD=OFF -DCLANG_TOOL_SCAN_BUILD_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_SCAN_BUILD_PY_BUILD=OFF -DCLANG_TOOL_SCAN_VIEW_BUILD=OFF "
export BOFF+="-DCLANG_TOOL_AMDGPU_ARCH_BUILD=OFF "

# Configure source
cmake -B build -G Ninja -Wno-dev -S llvm  \
      -DCMAKE_EXE_LINKER_FLAGS="${LINKERFLAGS}"    \
      -DCMAKE_SHARED_LINKER_FLAGS="${LINKERFLAGS}" \
      ${CONFIG_TOOLS} ${CONFIG_TUPLES} \
      ${CONFIG_CRT} ${CONFIG_CLANG} ${CONFIG_OPTIONS} \
      ${CONFIG_LIBUNWIND} ${CONFIG_LIBCXXABI} \
      ${CONFIG_LIBCXX} ${CONFIG_PATHS} ${BUILD_OFF} ${BOFF}  \
      -DLLVM_ENABLE_PROJECTS="clang;compiler-rt;libcxx;libcxxabi;lld;libunwind" \
      -DCLANG_VENDOR="llvmtools 3.0.0" -DLLD_VENDOR="llvmtools 3.0.0"

# Compile
ninja -C build

# When build fails, troubleshoot by building individual targets:
#ninja -C build builtins #166 targets .............. PASS
#ninja -C build unwind   #19 ....................... PASS
#ninja -C build cxxabi   #828 ...................... PASS
#ninja -C build cxx      #89 ....................... PASS
#ninja -C build compiler-rt #578 ................... PASS
#ninja -C build llvm-tblgen #246 ................... PASS
#ninja -C build lld      #1465 ..................... PASS
#ninja -C build libclang #795 ...................... PASS
#ninja -C build clang    #96 ....................... PASS
#ninja -C build llvm-lib #8 ........................ PASS
#ninja -C build          #1024 ..................... PASS

# Install to /cgnutools
ninja -C build builtins
ninja -C build install-unwind
ninja -C build install-cxxabi
ninja -C build install-cxx
ninja -C build install-compiler-rt
ninja -C build install-lld
ninja -C build install-libclang
ninja -C build install-clang

# Install the support libraries:
ninja -C build install-llvm-libraries
ninja -C build install-clangBasic
ninja -C build install-clangSerialization
ninja -C build install-clangCodeGen
ninja -C build install-clangFrontend
ninja -C build install-clangFrontendTool
ninja -C build install-clangDriver
ninja -C build install-clangExtractAPI
ninja -C build install-clangLex
ninja -C build install-clangAST
ninja -C build install-clangSema
ninja -C build install-clangEdit
ninja -C build install-clangParse
ninja -C build install-clangRewrite
ninja -C build install-clangRewriteFrontend
ninja -C build install-clangSupport
ninja -C build install-clangAnalysis
ninja -C build install-clangIndex
ninja -C build install-clangASTMatchers
ninja -C build install-clangToolingCore
ninja -C build install-clangFormat
ninja -C build install-clangToolingInclusions
ninja -C build install-builtins-standalone-atomic
ninja -C build install-LLVMDlltoolDriver

# Install the dependencies for LLD
cmake --install build/tools/lld/ELF
cmake --install build/tools/lld/Common
cmake --install build/tools/lld/MachO
cmake --install build/tools/lld/MinGW
cmake --install build/tools/lld/wasm
cmake --install build/tools/lld/COFF

# Install LLVM's binary tools:
for b in addr2line ar as config lib link nm objcopy objdump ranlib \
         readelf readobj symbolizer size strip strings tblgen
do
  ninja -C build install-llvm-$b
done

# Install additional headers:
for h in x86-resource libclang utility-resource ve-resource compiler-rt \
         clang-resource clang unwind cxxabi cxx compiler-rt core-resource
do
  ninja -C build install-$h-headers
done

# Clean up current environment...
unset CFLAGS CXXFLAGS CONFIG_TOOLS CONFIG_TUPLES
unset CONFIG_CRT CONFIG_CLANG CONFIG_OPTIONS BOFF
unset CONFIG_LIBUNWIND CONFIG_LIBCXXABI CONFIG_LIBCXX
unset CONFIG_PATHS BUILD_OFF LLVMSRC LINKERFLAGS CC CXX

# Fix link for libunwind:
rm -rf /llvmtools/lib/libunwind.so.1
ln -sv ${TARGET_TUPLE}/libunwind.so.1.0 /llvmtools/lib/libunwind.so.1

# Some packages will try to use cc. Make a link for it.
ln -sv clang-15 /llvmtools/bin/cc

# Some packages will look for GNU's binutils. Create a script
# to create links for GNU's to LLVM's
cat > /llvmtools/bin/set-llvm-bin-mode << "EOF"
#! /bin/bash
echo "[ 1 / 1 ] Setting LLVM tools as system binary tools..." && \
for b in  addr2line ar as nm objcopy objdump ranlib readelf size strings strip
do
  rm -v /llvmtools/bin/$b
done

for b in ar as nm objcopy objdump size strings
do
  ln -sv llvm-$b /llvmtools/bin/$b
done

rm -rf /llvmtools/bin/c++filt
ln -sv llvm-cxxfilt /llvmtools/bin/c++filt

ln -sv llvm-symbolizer /llvmtools/bin/addr2line     && \
ln -sv llvm-ar         /llvmtools/bin/ranlib        && \
ln -sv llvm-readobj    /llvmtools/bin/readelf       && \
ln -sv llvm-objcopy    /llvmtools/bin/strip         && \

echo "[ info  ] LLVM Binary tools set as system default"
EOF

chmod -v +x /llvmtools/bin/set-llvm-bin-mode

# Make lld as the default linker
ln -sv ld.lld /llvmtools/bin/ld

# Test stage 1 clang
echo "int main(){}" > dummy.c
/llvmtools/bin/clang dummy.c -v -Wl,--verbose &> dummy.log
setDL a.out
readelf -l a.out | grep ': /llvmtools'
# Shoud output:
# [Requesting program interpreter: /llvmtools/lib/ld-musl-x86_64.so.1

# Check if the correct start files are used
grep  'crt[1in]' dummy.log | grep ld.lld:
# Should output:
# ld.lld: /llvmtools/lib/Scrt1.o
# ld.lld: /llvmtools/lib/crti.o
# ld.lld: /llvmtools/lib/crtn.o

# Make sure no libraries are loaded from the host or
# from cgnutools
grep ld.lld:  dummy.log
# Should output:
# ld.lld: /llvmtools/lib/Scrt1.o
# ld.lld: /llvmtools/lib/crti.o
# ld.lld: /mnt/cmlfs/llvmtools/lib/clang/15.0.5/lib/x86_64-pc-linux-musl/clang_rt.crtbegin.o
# ld.lld: /tmp/dummy-001093.o
# ld.lld: /mnt/cmlfs/llvmtools/lib/clang/15.0.5/lib/linux/libclang_rt.builtins.a
# ld.lld: /mnt/cmlfs/llvmtools/bin/../lib/x86_64-pc-linux-musl/libunwind.so
# ld.lld: /llvmtools/lib/libc.so
# ld.lld: /mnt/cmlfs/llvmtools/lib/clang/15.0.5/lib/linux/libclang_rt.builtins.a
# ld.lld: /mnt/cmlfs/llvmtools/bin/../lib/x86_64-pc-linux-musl/libunwind.so
# ld.lld: /mnt/cmlfs/llvmtools/lib/clang/15.0.5/lib/x86_64-pc-linux-musl/clang_rt.crtend.o
# ld.lld: /llvmtools/lib/crtn.o

# Check if clang++ [in llvmtools] has atomics.
cat > atomics-test.cpp << "EOF"
#include <atomic>
std::atomic<int> x;
std::atomic<short> y;
std::atomic<char> z;
int main() {
  ++z;
  ++y;
  return ++x;
}
EOF

/llvmtools/bin/clang++ \
atomics-test.cpp -v -Wl,--verbose &> atomics-test.log

# Check for errors during compile or link:
grep error:  atomics-test.log

# Should return nothing if there are no errors.

# Make sure stage 1 libc++ & libc++abi do not depend on GCC
readelf -d /llvmtools/lib/${TARGET_TUPLE}/libc++.so.1.0 | grep Shared | cut -d ":" -f 2
# Should output
# [libc.so]
# [libc++abi.so.1]
# [libunwind.so.1]

readelf -d /llvmtools/lib/${TARGET_TUPLE}/libc++abi.so.1.0 | grep Shared | cut -d ":" -f 2
# Should output
# [libc.so]
# [libunwind.so.1]

# Test if stage0 clang support C++11
cat > cxx11-test.cpp << "EOF"
#include <iostream>

int main(){
   #if __cplusplus==201402L
   std::cout << "C++14" << std::endl;
   #elif __cplusplus==201103L
   std::cout << "C++11" << std::endl;
   #else
   std::cout << "C++" << std::endl;
   #endif

   return 0;
}
EOF

/llvmtools/bin/clang++ cxx11-test.cpp \
-v -Wl,--verbose &> cxx11-test.log

# Check for errors during compile or link:
grep error: cxx11-test.log

# Should return nothing if there are no errors.

# Test should output C++14
setDL a.out
./a.out

# Clean up
rm -rf build

# Source tree will be used later. Save time by not removing
