# cgnutools: Stage1 Clang ( with compiler-rt, lld)
#
# Build as cmlfs
#

# Rename for shorter paths:
mv llvm-project-15.0.5.src llvm
export LLVMSRC=${CMLFS}/sources/llvm

cd $LLVMSRC

# Apply patches for main LLVM source ... from alpine linux:
patch -Np1 -i ../patches/llvm15-alpine/0001-Disable-dynamic-lib-tests-for-musl-s-dlclose-is-noop.patch
patch -Np1 -i ../patches/llvm15-alpine/fix-memory-mf_exec-on-aarch64.patch
patch -Np1 -i ../patches/llvm15-alpine/install-prefix.patch
patch -Np1 -i ../patches/llvm15-alpine/llvm-stack-size.patch

# Known broken test on musl
cd llvm
rm -v test/CodeGen/AArch64/wineh4.mir
# https://github.com/llvm/llvm-project/issues/47657
rm -v test/ExecutionEngine/Interpreter/intrinsics.ll

# If builing on x86, remove tests:
rm -v test/Object/macho-invalid.test test/tools/llvm-size/radix.test unittests/Support/JSONTest.cpp
sed -i "/JSONTest.cpp/d" unittests/Support/CMakeLists.txt

# If building on arm*, remove tests:
rm -v test/tools/llvm-readobj/ELF/dependent-libraries.test test/Object/macho-invalid.test \
      test/tools/llvm-size/radix.test test/tools/gold/X86/split-dwarf.ll \
      test/ExecutionEngine/frem.ll test/tools/llvm-dwarfdump/X86/prettyprint_types.s \
      test/tools/llvm-dwarfdump/X86/simplified-template-names.s \
      unittests/ExecutionEngine/Orc/OrcCAPITest.cpp \
      test/CodeGen/RISCV/rv32zbp.ll \
      test/CodeGen/RISCV/rv64zbp.ll
sed -i "/OrcCAPITest.cpp/d" unittests/ExecutionEngine/Orc/CMakeLists.txt

# Return to top-level
cd ..

# Apply patches for clang
cd clang
patch -Np1 -i ../../patches/llvm15-clang-alpine/10-add-musl-triples.patch
patch -Np1 -i ../../patches/llvm15-clang-alpine/clang-003-as-needed.patch

# Apply patches for compiler-rt 
cd ../compiler-rt
patch -Np2 -i ../../patches/llvm15-compiler-rt-alpine/compiler-rt-sanitizer-ppc64-musl.patch
patch -Np2 -i ../../patches/llvm15-compiler-rt-alpine/compiler-rt-sanitizer-supported-arch.patch

# Apply patches for libcxx
cd ../libcxx
patch -Np2 -i ../../patches/llvm15-libcxx-alpine/libcxx-musl.patch
patch -Np2 -i ../../patches/llvm15-libcxx-alpine/libcxx-ppc.patch

cd ..

# Set flags to greatly reduce debugging symbols
#CFLAGS=' -g -g1 -Wl,--as-needed -lexecinfo'
CFLAGS="-g -g1  "
CXXFLAGS=$CFLAGS
export CFLAGS CXXFLAGS

# Set the compiler and linker flags...
export LINKERFLAGS="-Wl,-dynamic-linker /llvmtools/lib/ld-musl-x86_64.so.1"
export  CTOOLS="-DCMAKE_C_COMPILER=${TARGET_TUPLE}-clang "
export CTOOLS+="-DCMAKE_CXX_COMPILER=${TARGET_TUPLE}-clang++ "
export CTOOLS+="-DCLANG_DEFAULT_LINKER=/cgnutools/bin/ld.lld "

# Set the tuples & build target ...
export  CTARG="-DLLVM_DEFAULT_TARGET_TRIPLE=x86_64-pc-linux-musl "
export CTARG+="-DLLVM_HOST_TRIPLE=x86_64-pc-linux-musl "
export CTARG+="-DCOMPILER_RT_DEFAULT_TARGET_TRIPLE=x86_64-pc-linux-musl "
export CTARG+="-DLLVM_TARGETS_TO_BUILD=X86 "
export CTARG+="-DLLVM_TARGET_ARCH=X86 "
export CTARG+="-DLLVM_TARGETS_TO_BUILD=Native "

# Set the paths ...
export  CPATHS="-DCMAKE_INSTALL_PREFIX=/llvmtools "
export CPATHS+="-DDEFAULT_SYSROOT=/llvmtools "
export CPATHS+="-DLIBUNWIND_INSTALL_LIBRARY_DIR=/llvmtools/lib "
export CPATHS+="-DCMAKE_INSTALL_OLDINCLUDEDIR=/llvmtools/include "

# Set bootstrap options..
export  CBSTRAP="-DBOOTSTRAP_CMAKE_BUILD_TYPE=Release "
export CBSTRAP+="-DCLANG_ENABLE_BOOTSTRAP=ON "
export CBSTRAP+="-DBOOTSTRAP_CLANG_DEFAULT_CXX_STDLIB=libc++ "
export CBSTRAP+="-DBOOTSTRAP_CLANG_DEFAULT_RTLIB=compiler-rt "
export CBSTRAP+="-DBOOTSTRAP_LIBCXX_USE_COMPILER_RT=ON "       
export CBSTRAP+="-DBOOTSTRAP_LIBCXXABI_USE_COMPILER_RT=ON "    
export CBSTRAP+="-DBOOTSTRAP_LIBCXXABI_USE_LLVM_UNWINDER=ON " 
export CBSTRAP+="-DBOOTSTRAP_LLVM_USE_LINKER=lld "
export CBSTRAP+="-DBOOTSTRAP_LIBUNWIND_USE_COMPILER_RT=ON "    

# Set the standard C++ library that clang will use to LLVM's libc++:
export  COPTS="-DCLANG_DEFAULT_CXX_STDLIB=libc++ "

# Set the runtime library that clang will use to compiler-rt:
export COPTS+="-DCLANG_DEFAULT_RTLIB=compiler-rt "

# Set libc++abi & libc++ to use compiler-rt instead of gcc's runtime:
export COPTS+="-DLIBCXX_USE_COMPILER_RT=ON " # YES--OFF?
export COPTS+="-DLIBCXXABI_USE_COMPILER_RT=ON "

# Set libc++abi to use libunwind to avoid dependence on GCC:
export COPTS+="-DLIBCXXABI_USE_LLVM_UNWINDER=ON " # YES--OFF?

# Enable Exception Handling:
export COPTS+="-DLLVM_ENABLE_EH=ON "

# Exception handling requires Runtime Type Info
export COPTS+="-DLLVM_ENABLE_RTTI=ON "

# Stage 1 clang's compiler-rt will require new delete definitions in libc++
export COPTS+="-DLIBCXX_ENABLE_NEW_DELETE_DEFINITIONS=ON"

# Turn off features ...
export  BOFF="-DLLVM_ENABLE_LIBXML2=OFF  -DLIBCXX_ENABLE_LOCALIZATION=OFF "
export BOFF+="-DLLVM_ENABLE_ZLIB=OFF     -DCLANG_TOOL_AMDGPU_ARCH_BUILD=OFF "
export BOFF+="-DLLVM_ENABLE_ZSTD=OFF     -DLIBUNWIND_INCLUDE_TESTS=OFF "
export BOFF+="-DLLVM_ENABLE_LIBEDIT=OFF  -DLIBUNWIND_INCLUDE_DOCS=OFF "

export BOFF+="-DLLVM_INCLUDE_DOCS=OFF -DLLVM_INCLUDE_EXAMPLES=OFF -DLLVM_INCLUDE_TESTS=OFF "

# Turn off features that cause compiler-rt to NOT reference backtrace symbols from libexecinfo
export BOFF+="-DCOMPILER_RT_BUILD_GWP_ASAN=OFF "
export BOFF+="-DCOMPILER_RT_BUILD_LIBFUZZER=OFF "
export BOFF+="-DCOMPILER_RT_BUILD_ORC=OFF " #-DLIBCXX_ENABLE_NEW_DELETE_DEFINITIONS=ON "

# Compile source ... with installed runtimes in llvmtools?
cmake -B build -G Ninja -Wno-dev -S llvm  \
  -DCMAKE_BUILD_TYPE=Release \
  -DLLVM_ENABLE_PROJECTS="lld;clang" \
  -DLLVM_ENABLE_RUNTIMES="compiler-rt;libunwind" \
  -DCMAKE_EXE_LINKER_FLAGS="${LINKERFLAGS}" \
  -DCMAKE_SHARED_LINKER_FLAGS="${LINKERFLAGS}  -Wl,--as-needed -lexecinfo" \
  ${CTOOLS} ${CTARG} ${CPATHS} ${BOFF} ${COPTS} -DCLANG_DEFAULT_UNWINDLIB=libunwind -DCOMPILER_RT_USE_LLVM_UNWINDER=ON \
  -DLIBUNWIND_INSTALL_HEADERS=ON -DLIBUNWIND_USE_COMPILER_RT=ON -DCOMPILER_RT_CXX_LIBRARY=libcxx -DCOMPILER_RT_USE_BUILTINS_LIBRARY=ON

# Manually-specified variables were not used by the project:
#    LIBCXXABI_USE_COMPILER_RT
#    LIBCXXABI_USE_LLVM_UNWINDER
#    LIBCXX_ENABLE_LOCALIZATION
#    LIBCXX_ENABLE_NEW_DELETE_DEFINITIONS
#    LIBCXX_USE_COMPILER_RT

# Compile only what we need for a stage 1 clang
ninja -C build builtins #165 targets
ninja -C build unwind #19
ninja -C build cxxabi #829 
ninja -C build cxx #77
ninja -C build compiler-rt # 598 ........fails. Can't find unwind.h ...and missing headers in /cgnutools/lib/clang/15.0.5/include
ninja -C build lld #1652 
ninja -C build libclang #798
ninja -C build clang #288

# Configure source ...
# The llvm-project source tree seems to not use the installed LLVM runtimes 
# (libc++abi,libc++, libunwind) in llvmtools.
cmake -B build -G Ninja -Wno-dev -S llvm  \
  -DCMAKE_BUILD_TYPE=Release \
  -DLLVM_ENABLE_PROJECTS="compiler-rt;libunwind;libcxx;libcxxabi;lld;clang" \
  -DCMAKE_EXE_LINKER_FLAGS="${LINKERFLAGS}" \
  -DCMAKE_SHARED_LINKER_FLAGS="${LINKERFLAGS}  -Wl,--as-needed -lexecinfo" \
  ${CTOOLS} ${CTARG} ${CPATHS} ${CBSTRAP} ${BOFF} ${COPTS} -DCLANG_DEFAULT_UNWINDLIB=libunwind -DCOMPILER_RT_USE_LLVM_UNWINDER=ON \
  -DLIBUNWIND_INSTALL_HEADERS=ON -DLIBUNWIND_USE_COMPILER_RT=ON -DCOMPILER_RT_CXX_LIBRARY=libcxx -DCOMPILER_RT_USE_BUILTINS_LIBRARY=ON \
  -DCOMPILER_RT_TERMINFO_LIB=/llvmtools/lib/libcurses.so -DC_INCLUDE_DIRS=/llvmtools/include -DLLVM_ENABLE_TERMINFO=OFF \
  -DBacktrace_INCLUDE_DIR=/llvmtools/include -DLIBCXX_HAS_MUSL_LIBC=ON #-DCOMPILER_RT_BUILD_STANDALONE_LIBATOMIC=OFF 

# Compile
ninja -C build builtins
ninja -C build unwind
ninja -C build cxxabi
ninja -C build cxx # .............. Stage 0 clang still lacks atomics... need lib/clang/14.0.5/lib/linux/libclang_rt.tsan-x86_64.so ?
ninja -C build compiler-rt 
