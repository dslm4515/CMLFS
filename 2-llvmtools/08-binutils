# Llvmtools: Binutils
# Build and install as cmlfs

# Set stage0 clang as C/C++ compiler
export CC=${TARGET_TUPLE}-clang CXX=${TARGET_TUPLE}-clang++

# Configure in dedicated build directory
mkdir -v build && cd build

# binutils-2.38
CC=$CC CXX=$CXX AR=llvm-ar AS=llvm-as \
RANLIB=llvm-ranlib LD=ld.lld STRIP=llvm-strip \
../configure --prefix=/llvmtools \
  --with-lib-path=/llvmtools/lib \
  --build=${TARGET_TUPLE} \
  --host=${TARGET_TUPLE} \
  --target=${TARGET_TUPLE} \
  --disable-nls \
  --disable-werror \
  --with-sysroot

# Build
make

# Install
make install

# Clean source to rebuild linker
make -C ld clean

# Build and install linker that will be used later after adjusting toolchain
make -C ld LIB_PATH=/usr/lib:/lib
cp -v ld/ld-new /llvmtools/bin/ld.bfd-new

# Set lld as default linker
rm -rf /llvmtools/bin/ld
ln -sv lld /llvmtools/bin/ld

# Binary tools from LLVM will be the default.
for b in addr2line ar as nm objcopy objdump ranlib readelf \
         size strings strip
do
  mv -v  /llvmtools/bin/{$b,$b.gnu}
  ln -sv llvm-$b /llvmtools/bin/$b
done

mv -v    /llvmtools/bin/{c++filt,c++filt.gnu}
ln -sv  llvm-cxxfilt /llvmtools/bin/c++filt

# There are no LLVM counterparts for gprof & elfedit

# Create script to binutils as the default binary tools
# since some packages are hardcoded.
cat > /llvmtools/bin/set-gnu-bin-mode << "EOF"
#! /bin/bash
echo "[ 1 / 1 ] Setting GNU binutils as system binary tools..." && \
for b in addr2line ar as nm objcopy objdump ranlib readelf size strings strip c++filt
do
  rm -v         /llvmtools/bin/$b
  ln -sv $b.gnu /llvmtools/bin/$b
done                                          && \
echo "[ info  ] GNU Binutils  set as system default binary tools"
EOF
chmod -v +x /llvmtools/bin/set-gnu-bin-mode

# Create another script to set the LLVM binary tools
# as the system defaults

cat > /llvmtools/bin/set-llvm-bin-mode << "EOF"
#! /bin/bash
echo "[ 1 / 1 ] Setting LLVM tools as system binary tools..." && \
for b in  addr2line ar as nm objcopy objdump ranlib readelf size strings strip 
do
  rm -v /llvmtools/bin/$b
done

for b in ar as nm objcopy objdump size strings 
do
  ln -sv llvm-$b /llvmtools/bin/$b
done

rm -rf /llvmtools/bin/c++filt
ln -sv llvm-cxxfilt /llvmtools/bin/c++filt

ln -sv llvm-symbolizer /llvmtools/bin/addr2line     && \
ln -sv llvm-ar         /llvmtools/bin/ranlib        && \
ln -sv llvm-readobj    /llvmtools/bin/readelf       && \
ln -sv llvm-objcopy    /llvmtools/bin/strip         && \

echo "[ info  ] LLVM Binary tools set as system default"
EOF
chmod -v +x /llvmtools/bin/set-llvm-bin-mode

unset CARGS
