# Final System: libunwind
# Build and install in chroot

# NOTE: Reused unpacked LLVM source from building cgnutools 

cd libunwind

# Set the build options ..
export  CONFIG_OPTIONS="-DCMAKE_BUILD_TYPE=Release "
export CONFIG_OPTIONS+="-DBUILD_SHARED_LIBS=ON "

# Set the compiler and linker flags...
export  CONFIG_TOOLS="-DCMAKE_C_COMPILER=${CC} "
export CONFIG_TOOLS+="-DCMAKE_CXX_COMPILER=${CXX} "

# Make sure libunwind is built as static and shared
export  CONFIG_LIBUNWIND="-DLIBUNWIND_ENABLE_STATIC=ON "
export CONFIG_LIBUNWIND+="-DLIBUNWIND_ENABLE_SHARED=ON "
export CONFIG_LIBUNWIND+="-DLIBUNWIND_INSTALL_HEADERS=ON "
export CONFIG_LIBUNWIND+="-D LIBUNWIND_USE_COMPILER_RT=ON "

# Set paths...
export  CONFIG_PATHS="-DCMAKE_INSTALL_PREFIX=/usr "
export CONFIG_PATHS+="-DLIBUNWIND_INSTALL_LIBRARY_DIR=/usr/lib "

cmake -B build -G Ninja -Wno-dev \
      $CONFIG_OPTIONS $CONFIG_TOOLS $CONFIG_LIBUNWIND \
      $CONFIG_PATHS

# Compile
ninja -C build unwind

# Install
ninja -C build install-unwind

unset CONFIG_OPTIONS CONFIG_TOOLS CONFIG_LIBUNWIND CONFIG_PATHS
