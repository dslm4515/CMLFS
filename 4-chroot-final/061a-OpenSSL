# Final System: OpenSSL
# This section is done in Chroot environment
#
# NOTE: Python 3.10+ no longer supports libreSSL.
# Build OpenSSL as an auxillary package to build
# Python3
# NOTE: Fails to build with final system clang.
# compiles fine with stage0 clang

# Make stage0 clang available
export OLDPATH=$PATH
export PATH=/bin:/usr/bin:/sbin:/usr/sbin:/cgnutools/bin:/llvmtools/bin

# Configure source to install in /opt/openssl
CC=x86_64-pc-linux-musl-clang \
CXX=x86_64-pc-linux-musl-clang \
CFLAGS="-I/usr/include" \
CXXFLAGS=$CFLAGS \
./config --prefix=/opt/openssl \
         --openssldir=/opt/openssl/etc/ssl \
         --libdir=lib          \
         shared                \
         zlib-dynamic
# Compile
make

# Install to /opt
sed -i '/INSTALL_LIBS/s/libcrypto.a libssl.a//' Makefile
make MANSUFFIX=ssl install

# Disable use of stage0 clang
export PATH=$OLDPATH

# Alpinelinux's method:
# perl ./Configure linux-x86_64 --prefix=/opt/openssl \
#                --libdir=lib --openssldir=/opt/openssl/etc/ssl \
#                enable-ktls shared no-zlib no-async no-comp \
#                no-idea  no-mdc2 no-rc5 no-ec2m no-sm2 no-sm4 \
#                no-ssl3 no-seed no-weak-ssl-ciphers \
#                enable-ec_nistp_64_gcc_128 -Wa,--noexecstack
#make
#make install
