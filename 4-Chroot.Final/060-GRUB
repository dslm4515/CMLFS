# Final system: grub
# Build under chroot

# Apply patches from Chimera linux
patch -Np1 -i ../patches/grub-chimera/arm64.patch
patch -Np1 -i ../patches/grub-chimera/disable-falign-loops.patch
patch -Np1 -i ../patches/grub-chimera/freestanding-no-interp.patch
patch -Np1 -i ../patches/grub-chimera/ieee1275-clear-reset.patch
patch -Np1 -i ../patches/grub-chimera/install-powerpc-machtypes.patch
patch -Np1 -i ../patches/grub-chimera/install-xen-binaries.patch
patch -Np1 -i ../patches/grub-chimera/nope.patch
patch -Np1 -i ../patches/grub-chimera/os-prober-osx86.patch
patch -Np1 -i ../patches/grub-chimera/ppc64le-disable-vsx.patch
patch -Np1 -i ../patches/grub-chimera/riscv64-call.patch
patch -Np1 -i ../patches/grub-chimera/x86_64-efi.patch

# Create config.cache:
cat > config.cache << "EOF"
grub_cv_check_uscore_uscore_bss_start_symbol=yes
grub_cv_check_edata_symbol=yes
grub_cv_check_uscore_edata_symbol=no
grub_cv_check_end_symbol=yes
grub_cv_check_uscore_end_symbol=no
EOF

# for BIOS-based PCs:
CFLAGS="-Wno-error" \
AR=llvm-ar \
TARGET_NM=llvm-nm \
TARGET_RANLIB=llvm-ranlib \
TARGET_OBJCOPY=llvm-objcopy \
TARGET_STRIP=llvm-strip \
./configure --prefix=/usr          \
            --sbindir=/sbin        \
            --sysconfdir=/etc      \
            --disable-efiemu       \
            --disable-werror       \
            --cache-file=config.cache

# for UEFI-based PCs:
CFLAGS="-Wno-error" \
AR=llvm-ar \
TARGET_NM=llvm-nm \
TARGET_RANLIB=llvm-ranlib \
TARGET_OBJCOPY=llvm-objcopy \
TARGET_STRIP=llvm-strip \
./configure --prefix=/usr          \
            --target=x86_64        \
            --with-platform=efi    \
            --sbindir=/sbin        \
            --sysconfdir=/etc      \
            --disable-werror       \
            --cache-file=config.cache

# Modify project root Makefile and grub-core Makefile
sed -i 's/TARGET_IMG_LDFLAGS = -Wl,-N/TARGET_IMG_LDFLAGS = -Wl,-N,--no-pie/' Makefile
sed -i 's/TARGET_LDFLAGS_OLDMAGIC = -Wl,-N/TARGET_LDFLAGS_OLDMAGIC = -Wl,-N,--no-pie/' Makefile
sed -i 's/TARGET_IMG_LDFLAGS = -Wl,-N/TARGET_IMG_LDFLAGS = -Wl,-N,--no-pie/' grub-core/Makefile
sed -i 's/TARGET_LDFLAGS_OLDMAGIC = -Wl,-N/TARGET_LDFLAGS_OLDMAGIC = -Wl,-N,--no-pie/' grub-core/Makefile

# compile & install
make && make install
