# Final System: Linux Kernel
# Build under chroot

# Set the CPU architecture, required when compiling with clang
case $(uname -m) in
      i686)
    x86_64) export ARCH="x86"   ;;
   aarch64) export ARCH="arm64" ;;
     armv*) export ARCH="arm"   ;;
esac

# Prepare for compilation by running the following command:
LLVM=1 LLVM_IAS=1 ARCH=$ARCH make mrproper

# Configure kernel:
LLVM=1 LLVM_IAS=1 ARCH=$ARCH make menuconfig

# Compile the kernel image and modules:
LLVM=1 LLVM_IAS=1 make

# Install the modules, if the kernel configuration uses them:
LLVM=1 LLVM_IAS=1 make modules_install

# Install the kernel:
cp -iv arch/x86/boot/bzImage /boot/vmlinuz

# Install the symbol file for the kernel:
cp -iv System.map /boot/System.map

# Install the kernel configuration file .config produced by the make menuconfig:
cp -iv .config /boot/config

unset ARCH
