# Final System: Perl
# Build under chroot

# NOTE: Perl still doesn't support zlib-ng for the
# Compress-Raw-Zlib module.

# Perl is incompatible with zlib-ng.
# Use the bundled zlib source to build the Compress-Raw-Zlib module:
export BUILD_ZLIB=True
sed -i '/\(bzip2\|ZZZZ\)-src/d' MANIFEST

# Do not build the bundled bzip2 source. Use the system installed
# version:
export BUILD_BZIP2=0
rm -rf cpan/Compress-Raw-Bzip2/bzip2-src

export CF_OLD=$CFLAGS
export CFLAGS+=" -DNO_POSIX_2008_LOCALE"
export CFLAGS+=" -D_GNU_SOURCE"

patch -Np1 -i ../patches/perl-alpine/musl-locale.patch     &&
patch -Np1 -i ../patches/perl-alpine/musl-stack-size.patch

sh Configure -des                                         \
             -Dprefix=/usr                                \
             -Dvendorprefix=/usr                          \
             -Dprivlib=/usr/lib/perl5/5.36/core_perl      \
             -Darchlib=/usr/lib/perl5/5.36/core_perl      \
             -Dsitelib=/usr/lib/perl5/5.36/site_perl      \
             -Dsitearch=/usr/lib/perl5/5.36/site_perl     \
             -Dvendorlib=/usr/lib/perl5/5.36/vendor_perl  \
             -Dvendorarch=/usr/lib/perl5/5.36/vendor_perl \
             -Dman1dir=/usr/share/man/man1                \
             -Dman3dir=/usr/share/man/man3                \
             -Dpager="/usr/bin/less -isR"                 \
             -Duseshrplib                                 \
             -Dusethreads

make && make install
export CFLAGS=$CF_OLD
unset BUILD_ZLIB BUILD_BZIP2 CF_OLD

# Set the dynamic loader for each executable
setDL /usr/bin/perl
setDL /usr/bin/perl5.36.0
