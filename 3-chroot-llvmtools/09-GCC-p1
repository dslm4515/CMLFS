# llvmtools Chain: GCC
# Build and install as cmlfs

# Additional sources to add as GCC requires them
xz -cd ../pkgs/mpfr-4.1.1.tar.xz | tar -xf -
mv -v mpfr-4.1.1 mpfr
xz -cd ../pkgs/gmp-6.2.1.tar.xz | tar -xf -
mv -v gmp-6.2.1 gmp
gunzip -cd ../pkgs/mpc-1.2.1.tar.gz | tar -xf -
mv -v mpc-1.2.1 mpc

# Apply patches [from Glaucus]
patch -Np0 -i ../patches/glaucus/0001-pure64-for-x86-64.patch

# change the location of GCC's default dynamic linker to use the one installed in /llvmtools
#
# For i686/x86_64:
for file in gcc/config/{linux,i386/linux{,64}}.h
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/llvmtools&@g' \
      -e 's@/usr@/llvmtools@g' $file.orig > $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/llvmtools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
  touch $file.orig
done

# Configure in dedicated build directory
mkdir -v build && cd build

# Set build options:
export CARGS="--prefix=/llvmtools "
export CARGS+="--with-local-prefix=/llvmtools "
export CARGS+="--with-native-system-header-dir=/llvmtools/include "

# Enable only C++ and C languages
export CARGS+="--enable-languages=c,c++ "

# Disable features not supported by Musl
export CARGS+="--disable-libsanitizer "
export CARGS+="--disable-symvers "

# Disable features not needed during chroot
export CARGS+="--disable-libssp "
export CARGS+="--disable-libvtv "
export CARGS+="--disable-libitm "
export CARGS+="--disable-libgomp "
export CARGS+="--disable-multilib "
export CARGS+="--disable-bootstrap "
export CARGS+="--disable-libquadmath "
export CARGS+="--disable-libstdcxx-pch "
export CARGS+="--disable-libstdcxx "
export CARGS+="--disable-libatomic "
export CARGS+="--disable-libada "
export CARGS+="--disable-nls "

# set binary utilities to GNU's binutils, instead of LLVM's
/llvmtools/bin/set-gnu-bin-mode

# GCC can be compiled by clang!
# Configure source
# Need a patch to remove testing the compiler driver for ada
# support in toplevel configure and in ./gcc
acx_cv_cc_gcc_supports_ada=no \
CFLAGS='-g0 -O0 ' \
CXXFLAGS=$CFLAGS \
../configure $CARGS \
--target=x86_64-pc-linux-musl \
--host=x86_64-pc-linux-musl \
--build=x86_64-pc-linux-musl


# Compile
make

# Install
make install

# Re-create internal header for GCC installed in llvmtools/lib/gcc since
# the internal header that has just been installed is a partial,
# self-contained file and does not include the extended features of the system header
cp -v /llvmtools/lib/gcc/x86_64-pc-linux-musl/12.2.0/include-fixed/limits.h \
      /llvmtools/lib/gcc/x86_64-pc-linux-musl/12.2.0/include-fixed/limits.h.old
cat ../gcc/limitx.h ../gcc/glimits.h ../gcc/limity.h > \
    /llvmtools/lib/gcc/x86_64-pc-linux-musl/12.2.0/include-fixed/limits.h

unset CARGS
