# llvmtools: Libunwind (llvm-project-15.x.x-src)
# Build and install as cmlfs

# NOTE: Libunwind will depend on libgcc_s. It will be rebuilt later to drop
# libgcc_s

# Patch the source, as it will be re-used.

# Musl doesn't support strtoll_l(), so replace it with a simple strtoll() call.
# Apply patches to allow localization of libc++: Force 'abi' changes (glibc->musl)
# to source and disable xlocale.h (holds abi changes).
patch -Np1 -i ../patches/llvm1505-cmlfs/libcxx-use-strtoll_strtoul.patch

# Force 'abi' changes (glibc->musl) to source and disable xlocale.h (holds abi changes).
patch -Np1 -i ../patches/llvm1505-cmlfs/remove-locale-inlines.patch

# Known broken test on musl
rm -v llvm/test/CodeGen/AArch64/wineh4.mir
# https://github.com/llvm/llvm-project/issues/47657
rm -v llvm/test/ExecutionEngine/Interpreter/intrinsics.ll

# If builing on x86, remove tests:
rm -v llvm/test/Object/macho-invalid.test llvm/test/tools/llvm-size/radix.test llvm/unittests/Support/JSONTest.cpp
sed -i "/JSONTest.cpp/d" llvm/unittests/Support/CMakeLists.txt

# Disable dynamic lib tests for musl's dlclose() is noop
cd llvm
patch -Np1 -i ../../patches/llvm15-alpine/0001-Disable-dynamic-lib-tests-for-musl-s-dlclose-is-noop.patch
cd ..

# If building on arm*, remove tests:
rm -v llvm/test/tools/llvm-readobj/ELF/dependent-libraries.test \
      llvm/test/Object/macho-invalid.test \
      llvm/test/tools/llvm-size/radix.test \
      llvm/test/tools/gold/X86/split-dwarf.ll \
      llvm/test/ExecutionEngine/frem.ll \
      llvm/test/tools/llvm-dwarfdump/X86/prettyprint_types.s \
      llvm/test/tools/llvm-dwarfdump/X86/simplified-template-names.s \
      llvm/unittests/ExecutionEngine/Orc/OrcCAPITest.cpp \
      llvm/test/CodeGen/RISCV/rv32zbp.ll \
      llvm/test/CodeGen/RISCV/rv64zbp.ll
sed -i "/OrcCAPITest.cpp/d" llvm/unittests/ExecutionEngine/Orc/CMakeLists.txt

# Configure source in a build directory
CFLAGS='-L/llvmtools/lib -Wl,-rpath,"/llvmtools/lib" ' \
CXXFLAGS=$CFLAGS \
CC=${TARGET_TUPLE}-gcc  \
CXX=${TARGET_TUPLE}-g++ \
cmake -G Ninja -B build -S libunwind -Wno-dev \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INSTALL_PREFIX=/llvmtools \
      -DCMAKE_INSTALL_OLDINCLUDEDIR=/llvmtools/include \
      -DLIBUNWIND_INSTALL_HEADERS=ON

# Compile
ninja -C build unwind

# Install to llvmtools
ninja -C build install-unwind-stripped

# Remove build directory. Source tree will be re-used.
rm -rf build
